title Co-op Canvas Architecture

# Define Participants
participantgroup #lightgrey **Client Side**
    actor User
    participant "Raw Input Thread\n(Nuclear Option)" as RawInput
    participant "Main Thread\n(UI/SDL)" as ClientMain
    participant "TCP Receiver" as ClientTCP
    participant "UDP Receiver" as ClientUDP
end

participantgroup #lightblue **Server Side**
    participant "Server Main\n(Accept Loop)" as ServerMain
    participant "TCP Client Thread\n(One per Client)" as ServerTCP
    participant "UDP Canvas Thread\n(One per Canvas)" as ServerUDP
    participant "Autosave Thread" as ServerSave
end

# --- STARTUP & LOGIN FLOW ---
ServerMain->ServerSave: Start Autosave Thread
activate ServerSave

User->ClientMain: Starts App
ClientMain->ClientMain: Setup UI & SDL

opt --nuclear flag enabled
    ClientMain->RawInput: Start Thread
    activate RawInput
    note right of RawInput: Polls /dev/input/event*\nUpdates atomic pressure
end

User->ClientMain: Clicks "Login" (Canvas n)
ClientMain->ServerMain: TCP Connect (Port 6769)
activate ServerMain
ServerMain->ServerTCP: Start Client Thread
activate ServerTCP
ServerMain-->ClientMain: Connection Accepted
deactivate ServerMain

ClientMain->ServerTCP: MSG_LOGIN (Canvas n, Username)
note right of ServerTCP: Check if Canvas n exists.\nIf not, create it.

ServerTCP->ServerUDP: Start Canvas Thread (if needed)
activate ServerUDP
ServerUDP->ServerUDP: Bind UDP Port 6770+n

ServerTCP-->ClientMain: MSG_WELCOME (Layer Count)
ServerTCP-->ClientMain: MSG_CANVAS_DATA (Full Layer History)

# --- SIGNATURE SYNC ---
ClientMain->ServerTCP: MSG_SIGNATURE (256-byte Bitmap)
ServerTCP->ServerTCP: Store Signature in User Struct
ServerTCP->ClientTCP: Broadcast MSG_SIGNATURE (to ALL in room)
ClientTCP->ClientMain: Store Remote Signature

ClientMain->ClientTCP: Start TCP Receiver Thread
activate ClientTCP
ClientMain->ClientUDP: Start UDP Receiver Thread (Port 6772)
activate ClientUDP

# --- DRAWING FLOW (UDP) ---
note over User, ServerUDP: Real-time Drawing (UDP)

User->ClientMain: Drag Mouse (Draw)
opt --nuclear
    ClientMain->RawInput: Read Atomic Pressure
end
ClientMain->ClientMain: Apply Locally (Immediate Feedback)
ClientMain->ServerUDP: MSG_DRAW (UDP Packet)

ServerUDP->ServerUDP: Update Server Pixel Array
ServerUDP->ClientUDP: Broadcast MSG_DRAW (to other clients)
note right of ServerUDP: Sent to everyone EXCEPT sender

ClientUDP->ClientMain: Update Remote Layer
ClientMain->User: Render Frame

#--- CURSOR SYNCHRONIZATION ---
note over User, ServerUDP: Cursor Synchronization (UDP)

User->ClientMain: Move Mouse
ClientMain->ClientMain: Check Deduplication (Delta Check)
alt Position Changed
    ClientMain->ServerUDP: MSG_CURSOR (UDP Packet)
    ServerUDP->ClientUDP: Broadcast MSG_CURSOR (to other clients)
    note right of ServerUDP: Sent to everyone EXCEPT sender

    ClientUDP->ClientMain: Update remote_cursors Map
    ClientMain->User: Render Remote Cursors
else Position Unchanged
    ClientMain->ClientMain: Drop Packet (Optimization)
end

# --- LAYER MANAGEMENT FLOW (TCP) ---
note over User, ServerTCP: Layer Operations (TCP)

User->ClientMain: Click "Add Layer"
ClientMain->ServerTCP: MSG_LAYER_ADD

ServerTCP->ServerTCP: Create New Layer
ServerTCP->ClientTCP: Broadcast MSG_LAYER_ADD (New Count)

ClientTCP->ClientTCP: Update Local Layer Count
ClientTCP->ClientMain: Set pendingLayerUpdate = true
ClientMain->ClientMain: Update UI Buttons

User->ClientMain: Click "Delete Layer"
ClientMain->ServerTCP: MSG_LAYER_DEL

ServerTCP->ServerTCP: Delete Specified Layer
ServerTCP->ClientTCP: Broadcast MSG_LAYER_DEL (Deleted Layer ID)

ClientTCP->ClientTCP: Delete Layer Locally
ClientTCP->ClientMain: Set pendingLayerUpdate = true
ClientMain->ClientMain: Update UI Buttons

User->ClientMain: Drag Layer Button (Reorder)
ClientMain->ServerTCP: MSG_LAYER_REORDER (OldIdx, NewIdx)
ServerTCP->ServerTCP: Swap Layers in Memory
ServerTCP->ClientTCP: Broadcast MSG_LAYER_REORDER
ClientTCP->ClientMain: Swap Layers Locally

User->ClientMain: Ctrl+Drag Canvas (Move Layer)
ClientMain->ServerTCP: MSG_LAYER_MOVE (dx, dy)
ServerTCP->ServerTCP: Apply Offset to Layer
ServerTCP->ClientTCP: Broadcast MSG_LAYER_MOVE
ClientTCP->ClientMain: Apply Offset Locally

# --- UNDO / REDO SYNC FLOW ---
note over User, ServerTCP: Undo/Redo Synchronization (TCP)

User->ClientMain: Click "Undo" or "Redo"
ClientMain->ClientMain: Pop Snapshot & Restore Local Pixels

opt Layer Count Mismatch Detected
    alt Layers Restored (Undo Deletion / Redo Addition)
        ClientMain->ClientMain: Set ignore_layer_add++
        ClientMain->ServerTCP: MSG_LAYER_ADD (Restore Layer)
        ServerTCP->ClientTCP: Broadcast MSG_LAYER_ADD (to ALL)
        ClientTCP->ClientTCP: Check ignore_layer_add > 0?
        ClientTCP->ClientTCP: Yes -> Decrement & Ignore (Prevent Loop)
    else Layers Removed (Undo Addition / Redo Deletion)
        ClientMain->ClientMain: Set ignore_layer_del++
        ClientMain->ServerTCP: MSG_LAYER_DEL (Remove Layer)
        ServerTCP->ClientTCP: Broadcast MSG_LAYER_DEL (to ALL)
        ClientTCP->ClientTCP: Check ignore_layer_del > 0?
        ClientTCP->ClientTCP: Yes -> Decrement & Ignore (Prevent Loop)
    end
end

note right of ClientMain: Always sync pixel data (changed or not)
loop For Each Layer
    ClientMain->ServerTCP: MSG_LAYER_SYNC (Pixel Data)
    ServerTCP->ServerTCP: Update Server Layer State
    ServerTCP->ClientTCP: Broadcast MSG_LAYER_SYNC (to OTHERS only)
end

ClientMain->ClientMain: Clamp currentLayerId

# --- SAVE FLOW ---
note over User, ServerSave: Persistence

User->ClientMain: Click "Save"
ClientMain->ServerTCP: MSG_SAVE
ServerTCP->ServerSave: Trigger Save
ServerSave->ServerSave: Write canvas.json (Base64)

# --- AUTOSAVE FLOW ---
loop Every 60 Seconds
    ServerSave->ServerSave: Lock Mutex
    ServerSave->ServerSave: Write canvas.json
    ServerSave->ServerSave: Unlock Mutex
end

# --- DISCONNECT FLOW ---
User->ClientMain: Close Window
ClientMain->ServerTCP: Close Socket
ServerTCP->ServerMain: Client Disconnected
ServerTCP->ServerTCP: Remove from Lists

alt Server Crash / Shutdown
    ServerTCP->ClientTCP: Connection Closed (recv <= 0)
    ClientTCP->ClientMain: Set running = 0
    ClientMain->User: App Closes
end

# --- CLIENT-SIDE ACTIONS (Local) ---
note over User, ClientMain: Local Actions (No Network)

User->ClientMain: Select Color (Hue/Sat/Val)
ClientMain->ClientMain: Update userColor

User->ClientMain: Select Brush (Round/Square/Eraser)
ClientMain->ClientMain: Update currentBrushId

User->ClientMain: Click "Size +" or "Size -"
ClientMain->ClientMain: Update Brush Size

User->ClientMain: Click "Download"
ClientMain->ClientMain: SDL_SaveBMP (Save to Disk)
